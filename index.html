<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Monster Hunter Events Today</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            background-color: #333;
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #222;
            margin: 0;
            padding-bottom: 6em;
            text-align: center;
            overflow-x: hidden;
        }

        .container {
            background-color: #f6f4e4;
            padding: 20px;
        }

        .header {
            font-weight: bold;
        }

        .header__logo {
            max-width: 100%;
            margin-bottom: 20px;
        }

        .header__date {
            font-size: 1.75em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .header__heading {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 0;
        }

        main {
            text-align: left;
            max-width: 800px;
            margin: 0 auto;
        }

        section {
            margin: 20px 0;
        }

        .event-card {
            border-radius: 10px;
            background: #333;
            color: #f6f4e4;
            padding: 20px;
            display: flex;
            flex-direction: column;
            text-align: left;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .event-card__header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .event-card__time {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 10px;
        }

        .event-card__title {
            font-size: 20px; /* Adjusted font size */
            font-weight: 700;
            margin-bottom: 10px;
        }

        .event-card__description {
            font-size: 18px;
        }

        footer {
            background: #333;
            color: #ccc;
            text-align: center;
            padding: 10px;
        }

        footer ul {
            list-style: none;
            padding: 0;
        }

        footer ul li {
            display: inline-block;
            margin: 0 10px;
        }

        footer a {
            color: #4a90e2;
            text-decoration: none;
        }

        .heart {
            color: #bb0000;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <img src="docs/assets/monster-hunter-now-logo.png" alt="Monster Hunter Now Logo" class="header__logo" />
            <div class="header__date" id="tag-display-date"></div>
            <h1 class="header__heading">Monster Hunter Now Events</h1>
        </header>
        <main>
            <section id="all-day-events-container">
                <!-- All Day Events -->
            </section>
            <section id="timed-events-container">
                <!-- Timed Events -->
            </section>
            <section id="earlier-events-container">
                <!-- Earlier Events -->
            </section>
        </main>
    </div>

    <footer>
        <ul>
            <li>Made with <span class="heart">&hearts;</span> by Sean</li>
            <li><a href="https://github.com/seriouslysean/monster-hunter-now-events" target="_blank">GitHub</a></li>
            <li><a href="dist/events.ics">Calendar Subscription</a></li>
        </ul>
    </footer>

    <script type="text/javascript">
        // Function to format a date as a date string
        function formatDate(date) {
            return date.toLocaleDateString();
        }

        // Function to check if a date is within today's date range
        const isDateInTodayRange = (event, currentDate) => {
            if (event.startTime && event.endTime) {
                return event.startTime <= currentDate && event.endTime >= currentDate;
            }
            return false;
        };

        // Function to format a date as a time string
        const formatTime = (date) => {
            if (date.getHours() === 0 && date.getMinutes() === 0) {
                return 'All Day';
            } else if (date.getHours() === 0) {
                return `Ends at ${date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                })}`;
            } else if (date.getMinutes() === 0) {
                return `Starts at ${date.toLocaleTimeString([], {
                    hour: 'numeric',
                })}`;
            } else {
                return `${date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                })} - ${date.toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit',
                })}`;
            }
        };

        // Function to adapt event objects with required keys
        const adaptEvents = (events, currentDate) => {
            return events.reduce((adaptedEvents, event) => {
                if (event.dates && event.dates.length > 0) {
                    event.dates.forEach((dateObj) => {
                        const eventDate = new Date(dateObj.start);
                        const eventEndDate = new Date(dateObj.end);

                        if (
                            eventDate.toDateString() === currentDate.toDateString() ||
                            (currentDate >= eventDate && currentDate <= eventEndDate)
                        ) {
                            const { dates, ...adaptedEvent } = event; // Remove the dates array
                            adaptedEvent.startTime = eventDate;
                            adaptedEvent.endTime = eventEndDate;
                            adaptedEvents.push(adaptedEvent);
                        }
                    });
                }
                return adaptedEvents;
            }, []);
        };

        // Function to fetch JSON data
        const fetchEventData = async () => {
            try {
                const response = await fetch('dist/events.json');
                if (!response.ok) {
                    throw new Error(
                        'Unable to fetch the event data. Please try again later.'
                    );
                }
                const eventData = await response.json();
                return eventData;
            } catch (error) {
                console.error(`Error: ${error.message}`);
                return { events: [] };
            }
        };

        // Function to initialize the event display
        const initEventDisplay = (events, currentDate) => {
            const allDayEventsContainer = document.getElementById('all-day-events-container');
            const timedEventsContainer = document.getElementById('timed-events-container');
            const earlierEventsContainer = document.getElementById('earlier-events-container');

            // Update the header date display
            document.getElementById('tag-display-date').textContent = formatDate(currentDate);

            if (events.length === 0) {
                // Display a "No Events Found" message
                allDayEventsContainer.innerHTML = `
                    <div class="event-card">
                        <div class="event-card__header">
                            <div class="event-card__title">No Events Found</div>
                        </div>
                    </div>
                `;
                return;
            }

            const allDayEvents = events.filter((event) => event.isAllDay);
            const timedEvents = events.filter((event) => !event.isAllDay);

            // Clear the containers before rendering
            allDayEventsContainer.innerHTML = '';
            timedEventsContainer.innerHTML = '';
            earlierEventsContainer.innerHTML = '';

            const eventCards = (event) => `
                <div class="event-card">
                    <div class="event-card__header">
                        <div class="event-card__time">${formatTime(event.startTime)}</div>
                    </div>
                    <div class="event-card__header">
                        <div class="event-card__title">${event.summary}</div>
                    </div>
                    <div class="event-card__description">${event.description}</div>
                </div>
            `;

            // Display all-day events
            if (allDayEvents.length > 0) {
                allDayEventsContainer.innerHTML = allDayEvents.map(eventCards).join('');
            }

            // Display timed events
            if (timedEvents.length > 0) {
                timedEventsContainer.innerHTML = timedEvents.map(eventCards).join('');
            }

            // Display earlier events
            const pastTimedEvents = timedEvents.filter((event) => event.endTime < currentDate);
            if (pastTimedEvents.length > 0) {
                earlierEventsContainer.innerHTML = pastTimedEvents.map(eventCards).join('');
            } else {
                // Hide the container if no earlier events
                earlierEventsContainer.style.display = 'none';
            }
        };

        // Function to handle the initialization
        const init = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const seedDate = urlParams.get('date');
            let currentDate;

            // Use a date query param like 2023-10-31 to seed the current date for testing
            // Keep in mind that events older than 2 weeks are stripped from the event feed
            if (seedDate) {
                const [year, month, day] = seedDate.split('-');
                currentDate = new Date(year, month - 1, day);
            } else {
                currentDate = new Date();
            }

            const eventData = await fetchEventData();
            const adaptedEvents = adaptEvents(eventData.events, currentDate);

            initEventDisplay(adaptedEvents, currentDate);
        };

        // Ensure the document is fully loaded before initializing
        window.addEventListener('load', () => {
            init();
        });
    </script>
</body>
</html>
